"""RAG (Retrieval-Augmented Generation) —Å–µ—Ä–≤–∏—Å —Å –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π."""

import json
import uuid
from datetime import datetime
from typing import Any
import httpx

from ...core.config import get_settings
from ...schemas.ticket import TicketPriority

settings = get_settings()


# ============================================================================
# OpenAI Tools (Function Calling) –¥–ª—è —ç—Å–∫–∞–ª–∞—Ü–∏–∏
# ============================================================================

ESCALATION_TOOLS = [
    {
        "type": "function",
        "function": {
            "name": "escalate_to_operator",
            "description": """–ü–µ—Ä–µ–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É (—á–µ–ª–æ–≤–µ–∫—É) –∫–æ–≥–¥–∞:
- –í–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–π –∏–ª–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π
- –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–∏—Å—Ç–µ–º–∞–º
- –ö–ª–∏–µ–Ω—Ç —è–≤–Ω–æ –ø—Ä–æ—Å–∏—Ç –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º
- –ü—Ä–æ–±–ª–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- –ù–µ —É–¥–∞—ë—Ç—Å—è –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
- –°—Ä–æ—á–Ω–∞—è –∏–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞""",
            "parameters": {
                "type": "object",
                "properties": {
                    "reason": {
                        "type": "string",
                        "description": "–ü—Ä–∏—á–∏–Ω–∞ —ç—Å–∫–∞–ª–∞—Ü–∏–∏ (–ø–æ—á–µ–º—É AI –Ω–µ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å)"
                    },
                    "summary": {
                        "type": "string",
                        "description": "–ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –ø—Ä–æ–±–ª–µ–º—ã –∫–ª–∏–µ–Ω—Ç–∞"
                    },
                    "department": {
                        "type": "string",
                        "enum": ["it_support", "hr", "finance", "facilities"],
                        "description": "–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –æ—Ç–¥–µ–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"
                    },
                    "priority": {
                        "type": "string",
                        "enum": ["low", "medium", "high", "critical"],
                        "description": "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏—è"
                    },
                    "suggested_category": {
                        "type": "string",
                        "description": "–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø—Ä–æ–±–ª–µ–º—ã"
                    }
                },
                "required": ["reason", "summary", "department", "priority"]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "create_ticket",
            "description": """–°–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ –∫–æ–≥–¥–∞:
- –ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
- –ü—Ä–æ–±–ª–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
- –ù—É–∂–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏""",
            "parameters": {
                "type": "object",
                "properties": {
                    "subject": {
                        "type": "string",
                        "description": "–¢–µ–º–∞ —Ç–∏–∫–µ—Ç–∞ (–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ)"
                    },
                    "description": {
                        "type": "string",
                        "description": "–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã"
                    },
                    "department": {
                        "type": "string",
                        "enum": ["it_support", "hr", "finance", "facilities"],
                        "description": "–û—Ç–¥–µ–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏"
                    },
                    "priority": {
                        "type": "string",
                        "enum": ["low", "medium", "high", "critical"],
                        "description": "–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ç–∏–∫–µ—Ç–∞"
                    },
                    "client_email": {
                        "type": "string",
                        "description": "Email –∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–µ–Ω)"
                    }
                },
                "required": ["subject", "description", "department", "priority"]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "check_ticket_status",
            "description": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ç–∏–∫–µ—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É",
            "parameters": {
                "type": "object",
                "properties": {
                    "ticket_number": {
                        "type": "string",
                        "description": "–ù–æ–º–µ—Ä —Ç–∏–∫–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, TKT-241205-ABCD)"
                    }
                },
                "required": ["ticket_number"]
            }
        }
    },
    {
        "type": "function",
        "function": {
            "name": "mark_resolved_by_ai",
            "description": """–û—Ç–º–µ—Ç–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫–∞–∫ –†–ï–®–Å–ù–ù–û–ï AI, –∫–æ–≥–¥–∞:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç –∑–∞ –ø–æ–º–æ—â—å ("—Å–ø–∞—Å–∏–±–æ", "–±–ª–∞–≥–æ–¥–∞—Ä—é", "—Ä–∞—Ö–º–µ—Ç", "–ø–æ–º–æ–≥–ª–æ")
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ ("–≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç", "—Ä–∞–∑–æ–±—Ä–∞–ª—Å—è", "–ø–æ–Ω—è–ª", "–ø–æ–ª—É—á–∏–ª–æ—Å—å")
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç —á—Ç–æ –≤–æ–ø—Ä–æ—Å –∑–∞–∫—Ä—ã—Ç ("–±–æ–ª—å—à–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç", "—ç—Ç–æ –≤—Å—ë", "–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ")
- AI —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–≤–æ–ª–µ–Ω

–ù–ï –≤—ã–∑—ã–≤–∞–π –µ—Å–ª–∏:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—ë –µ—â—ë –∑–∞–¥–∞—ë—Ç –≤–æ–ø—Ä–æ—Å—ã
- –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ–¥–æ–≤–æ–ª–µ–Ω –∏–ª–∏ –∂–∞–ª—É–µ—Ç—Å—è
- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–º–æ—â—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞""",
            "parameters": {
                "type": "object",
                "properties": {
                    "resolution_summary": {
                        "type": "string",
                        "description": "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∫ –±—ã–ª–∞ —Ä–µ—à–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞"
                    },
                    "user_satisfaction": {
                        "type": "string",
                        "enum": ["positive", "neutral", "unknown"],
                        "description": "–û—Ü–µ–Ω–∫–∞ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                    },
                    "resolution_type": {
                        "type": "string",
                        "enum": ["faq_answer", "instruction_provided", "issue_clarified", "self_resolved"],
                        "description": "–¢–∏–ø —Ä–µ—à–µ–Ω–∏—è: –æ—Ç–≤–µ—Ç –∏–∑ FAQ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, –≤–æ–ø—Ä–æ—Å –ø—Ä–æ—è—Å–Ω—ë–Ω, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–∞–∑–æ–±—Ä–∞–ª—Å—è"
                    }
                },
                "required": ["resolution_summary", "user_satisfaction", "resolution_type"]
            }
        }
    }
]

# –ú–∞–ø–ø–∏–Ω–≥ –æ—Ç–¥–µ–ª–æ–≤
DEPARTMENT_MAPPING = {
    "it_support": {"id": "it", "name": "IT –ü–æ–¥–¥–µ—Ä–∂–∫–∞", "name_kz": "IT “ö–æ–ª–¥–∞—É"},
    "hr": {"id": "hr", "name": "HR / –ö–∞–¥—Ä—ã", "name_kz": "HR / –ö–∞–¥—Ä–ª–∞—Ä"},
    "finance": {"id": "finance", "name": "–§–∏–Ω–∞–Ω—Å—ã", "name_kz": "“ö–∞—Ä–∂—ã"},
    "facilities": {"id": "facilities", "name": "–ê–•–û", "name_kz": "–®“ö–ë"},
}


# –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
# –£—Ä–æ–≤–µ–Ω—å 1: –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
# –£—Ä–æ–≤–µ–Ω—å 2: –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏  
# –£—Ä–æ–≤–µ–Ω—å 3: –°—Ç–∞—Ç—å–∏/FAQ
HIERARCHICAL_KNOWLEDGE_BASE = {
    "it_support": {
        "name": "IT –ü–æ–¥–¥–µ—Ä–∂–∫–∞",
        "name_kz": "IT “ö–æ–ª–¥–∞—É",
        "keywords": ["–∫–æ–º–ø—å—é—Ç–µ—Ä", "–ø–∞—Ä–æ–ª—å", "–ø—Ä–∏–Ω—Ç–µ—Ä", "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç", "–ø—Ä–æ–≥—Ä–∞–º–º–∞", "–ø–æ—á—Ç–∞", "vpn", "—Å–µ—Ç—å", "–Ω–æ—É—Ç–±—É–∫", "–º–æ–Ω–∏—Ç–æ—Ä"],
        "subcategories": {
            "passwords": {
                "name": "–ü–∞—Ä–æ–ª–∏ –∏ –¥–æ—Å—Ç—É–ø",
                "keywords": ["–ø–∞—Ä–æ–ª—å", "–ª–æ–≥–∏–Ω", "–≤—Ö–æ–¥", "–¥–æ—Å—Ç—É–ø", "–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω", "—Å–±—Ä–æ—Å", "–∑–∞–±—ã–ª"],
                "articles": [
                    {
                        "question": "–ö–∞–∫ —Å–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å?",
                        "question_kz": "“ö“±–ø–∏—è —Å”©–∑–¥—ñ “õ–∞–ª–∞–π “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É–≥–µ –±–æ–ª–∞–¥—ã?",
                        "answer": """–î–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É
2. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Å—ã–ª–∫—É "–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?"
3. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π email
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É - –≤–∞–º –ø—Ä–∏–¥—ë—Ç –ø–∏—Å—å–º–æ —Å–æ —Å—Å—ã–ª–∫–æ–π –¥–ª—è —Å–±—Ä–æ—Å–∞
5. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∞—Ä–æ–ª—é:
‚Ä¢ –ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤
‚Ä¢ –•–æ—Ç—è –±—ã –æ–¥–Ω–∞ –∑–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞
‚Ä¢ –•–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Ü–∏—Ñ—Ä–∞
‚Ä¢ –•–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∏–º–≤–æ–ª

–ï—Å–ª–∏ –ø–∏—Å—å–º–æ –Ω–µ –ø—Ä–∏—à–ª–æ, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É "–°–ø–∞–º" –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ IT-–ø–æ–¥–¥–µ—Ä–∂–∫—É.""",
                        "answer_kz": "“ö“±–ø–∏—è —Å”©–∑–¥—ñ “õ–∞–ª–ø—ã–Ω–∞ –∫–µ–ª—Ç—ñ—Ä—É “Ø—à—ñ–Ω –∫—ñ—Ä—É –±–µ—Ç—ñ–Ω–µ ”©—Ç—ñ–ø, '“ö“±–ø–∏—è —Å”©–∑–¥—ñ “±–º—ã—Ç—Ç—ã“£—ã–∑ –±–∞?' —Ç“Ø–π–º–µ—Å—ñ–Ω –±–∞—Å—ã“£—ã–∑.",
                        "can_auto_resolve": True,
                        "priority": "low",
                    },
                    {
                        "question": "–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω",
                        "answer": """–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ —Å–ª–µ–¥—É—é—â–∏–º –ø—Ä–∏—á–∏–Ω–∞–º:

1. **3 –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞** - –ø–æ–¥–æ–∂–¥–∏—Ç–µ 15 –º–∏–Ω—É—Ç
2. **–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å** - –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ IT-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
3. **–ò—Å—Ç—ë–∫ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø–∞—Ä–æ–ª—è** - —Å–±—Ä–æ—Å—å—Ç–µ –ø–∞—Ä–æ–ª—å

–î–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:
‚Ä¢ –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –Ω–æ–º–µ—Ä 1234
‚Ä¢ –ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞ security@company.kz

–í—Ä–µ–º—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: –æ–±—ã—á–Ω–æ 5-10 –º–∏–Ω—É—Ç.""",
                        "can_auto_resolve": False,
                        "priority": "high",
                    },
                ],
            },
            "vpn": {
                "name": "VPN –∏ —É–¥–∞–ª—ë–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø",
                "keywords": ["vpn", "—É–¥–∞–ª–µ–Ω–Ω—ã–π", "–¥–æ–º", "–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ", "remote"],
                "articles": [
                    {
                        "question": "–ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ VPN?",
                        "answer": """–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º—É VPN:

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
1. –°–∫–∞—á–∞–π—Ç–µ VPN-–∫–ª–∏–µ–Ω—Ç —Å –ø–æ—Ä—Ç–∞–ª–∞: https://portal.company.kz/vpn
2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ VPN-–∫–ª–∏–µ–Ω—Ç
2. –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: vpn.company.kz
3. –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω (email) –∏ –ø–∞—Ä–æ–ª—å
4. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"

**–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º:**
‚Ä¢ –ù–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
‚Ä¢ –û—à–∏–±–∫–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ ‚Üí –æ–±–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
‚Ä¢ –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä""",
                        "can_auto_resolve": True,
                        "priority": "medium",
                    },
                ],
            },
            "hardware": {
                "name": "–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ",
                "keywords": ["–ø—Ä–∏–Ω—Ç–µ—Ä", "–º–æ–Ω–∏—Ç–æ—Ä", "–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞", "–º—ã—à—å", "–∫–æ–º–ø—å—é—Ç–µ—Ä", "–Ω–æ—É—Ç–±—É–∫", "–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"],
                "articles": [
                    {
                        "question": "–ü—Ä–∏–Ω—Ç–µ—Ä –Ω–µ –ø–µ—á–∞—Ç–∞–µ—Ç",
                        "answer": """–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ:

1. **–ü–∏—Ç–∞–Ω–∏–µ** - –ø—Ä–∏–Ω—Ç–µ—Ä –≤–∫–ª—é—á–µ–Ω?
2. **–ë—É–º–∞–≥–∞** - –µ—Å—Ç—å –ª–∏ –±—É–º–∞–≥–∞ –≤ –ª–æ—Ç–∫–µ?
3. **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - –≥–æ—Ä–∏—Ç –ª–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–µ—Ç–∏?
4. **–û—á–µ—Ä–µ–¥—å –ø–µ—á–∞—Ç–∏** - –Ω–µ—Ç –ª–∏ –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–¥–∞–Ω–∏–π?

**–ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ:**
–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–Ω—Ç–µ—Ä:
1. –í—ã–∫–ª—é—á–∏—Ç–µ –ø—Ä–∏–Ω—Ç–µ—Ä
2. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥
3. –í–∫–ª—é—á–∏—Ç–µ —Å–Ω–æ–≤–∞

–°–æ–∑–¥–∞–π—Ç–µ —Ç–∏–∫–µ—Ç —Å —Ñ–æ—Ç–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –ø—Ä–∏–Ω—Ç–µ—Ä–∞, –µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞.""",
                        "can_auto_resolve": False,
                        "priority": "medium",
                    },
                ],
            },
        },
    },
    "hr": {
        "name": "HR / –ö–∞–¥—Ä—ã",
        "name_kz": "HR / –ö–∞–¥—Ä–ª–∞—Ä",
        "keywords": ["–æ—Ç–ø—É—Å–∫", "–∑–∞—Ä–ø–ª–∞—Ç–∞", "—É–≤–æ–ª—å–Ω–µ–Ω–∏–µ", "–ø—Ä–∏–µ–º", "–±–æ–ª—å–Ω–∏—á–Ω—ã–π", "—Å–ø—Ä–∞–≤–∫–∞", "–¥–æ–≥–æ–≤–æ—Ä", "–æ—Ç–≥—É–ª"],
        "subcategories": {
            "vacation": {
                "name": "–û—Ç–ø—É—Å–∫–∞ –∏ –æ—Ç–≥—É–ª—ã",
                "keywords": ["–æ—Ç–ø—É—Å–∫", "–æ—Ç–≥—É–ª", "–≤—ã—Ö–æ–¥–Ω–æ–π", "–¥–Ω–∏"],
                "articles": [
                    {
                        "question": "–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –æ—Ç–ø—É—Å–∫?",
                        "answer": """–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –æ—Ç–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ HR-–ø–æ—Ä—Ç–∞–ª:

1. –í–æ–π–¥–∏—Ç–µ –≤ HR-–ø–æ—Ä—Ç–∞–ª: https://hr.company.kz
2. –†–∞–∑–¥–µ–ª "–û—Ç–ø—É—Å–∫–∞" ‚Üí "–ù–æ–≤–æ–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ"
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç–ø—É—Å–∫–∞:
   ‚Ä¢ –ï–∂–µ–≥–æ–¥–Ω—ã–π –æ–ø–ª–∞—á–∏–≤–∞–µ–º—ã–π
   ‚Ä¢ –ë–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—Ä–ø–ª–∞—Ç—ã
   ‚Ä¢ –£—á–µ–±–Ω—ã–π
4. –£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
5. –î–æ–±–∞–≤—å—Ç–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è
6. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ

**–í–∞–∂–Ω–æ:**
‚Ä¢ –ü–æ–¥–∞–≤–∞–π—Ç–µ –∑–∞—è–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏–º—É–º –∑–∞ 14 –¥–Ω–µ–π
‚Ä¢ –û—Ç–ø—É—Å–∫ –∑–∞ —Å–≤–æ–π —Å—á—ë—Ç - –∑–∞ 3 –¥–Ω—è
‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –æ—Å—Ç–∞—Ç–æ–∫ –¥–Ω–µ–π –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ""",
                        "can_auto_resolve": True,
                        "priority": "low",
                    },
                ],
            },
            "salary": {
                "name": "–ó–∞—Ä–ø–ª–∞—Ç–∞ –∏ –≤—ã–ø–ª–∞—Ç—ã",
                "keywords": ["–∑–∞—Ä–ø–ª–∞—Ç–∞", "–¥–µ–Ω—å–≥–∏", "–≤—ã–ø–ª–∞—Ç–∞", "–∞–≤–∞–Ω—Å", "–ø—Ä–µ–º–∏—è"],
                "articles": [
                    {
                        "question": "–ö–æ–≥–¥–∞ –≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç—Å—è –∑–∞—Ä–ø–ª–∞—Ç–∞?",
                        "answer": """–ì—Ä–∞—Ñ–∏–∫ –≤—ã–ø–ª–∞—Ç:

‚Ä¢ **–ê–≤–∞–Ω—Å:** 15 —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
‚Ä¢ **–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å:** –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞

–ï—Å–ª–∏ –¥–µ–Ω—å –≤—ã–ø–ª–∞—Ç—ã –≤—ã–ø–∞–¥–∞–µ—Ç –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–π - –≤—ã–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å.

**–†–∞—Å—á—ë—Ç–Ω—ã–π –ª–∏—Å—Ç–æ–∫:**
–î–æ—Å—Ç—É–ø–µ–Ω –≤ HR-–ø–æ—Ä—Ç–∞–ª–µ —á–µ—Ä–µ–∑ 1-2 –¥–Ω—è –ø–æ—Å–ª–µ –≤—ã–ø–ª–∞—Ç—ã.

–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é: payroll@company.kz""",
                        "can_auto_resolve": True,
                        "priority": "low",
                    },
                ],
            },
        },
    },
    "finance": {
        "name": "–§–∏–Ω–∞–Ω—Å—ã",
        "name_kz": "“ö–∞—Ä–∂—ã",
        "keywords": ["—Å—á—ë—Ç", "–æ–ø–ª–∞—Ç–∞", "–≤–æ–∑–≤—Ä–∞—Ç", "–±—é–¥–∂–µ—Ç", "invoice", "—Ä–∞—Å—Ö–æ–¥"],
        "subcategories": {
            "payments": {
                "name": "–ü–ª–∞—Ç–µ–∂–∏ –∏ —Å—á–µ—Ç–∞",
                "keywords": ["—Å—á—ë—Ç", "–æ–ø–ª–∞—Ç–∞", "–ø–ª–∞—Ç—ë–∂", "invoice"],
                "articles": [
                    {
                        "question": "–ö–∞–∫ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –æ–ø–ª–∞—Ç—É —Å—á—ë—Ç–∞?",
                        "answer": """–ü—Ä–æ—Ü–µ—Å—Å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –æ–ø–ª–∞—Ç—ã:

1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å—á—ë—Ç –≤ —Å–∏—Å—Ç–µ–º—É: https://finance.company.kz
2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É:
   ‚Ä¢ –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç
   ‚Ä¢ –°—É–º–º–∞
   ‚Ä¢ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
   ‚Ä¢ –¶–µ–Ω—Ç—Ä –∑–∞—Ç—Ä–∞—Ç
3. –ü—Ä–∏–ª–æ–∂–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä (–µ—Å–ª–∏ –µ—Å—Ç—å)
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ

**–°—Ä–æ–∫–∏:**
‚Ä¢ –î–æ 100 000 ‚Ç∏ - 1 —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
‚Ä¢ –î–æ 1 000 000 ‚Ç∏ - 3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è
‚Ä¢ –°–≤—ã—à–µ - –¥–æ 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π""",
                        "can_auto_resolve": False,
                        "priority": "medium",
                    },
                ],
            },
        },
    },
    "admin": {
        "name": "–ê–•–û",
        "name_kz": "”ò–∫—ñ–º—à—ñ–ª—ñ–∫-—à–∞—Ä—É–∞—à—ã–ª—ã“õ –±”©–ª—ñ–º—ñ",
        "keywords": ["–ø—Ä–æ–ø—É—Å–∫", "–∫–ª—é—á", "–æ—Ñ–∏—Å", "–º–µ–±–µ–ª—å", "—É–±–æ—Ä–∫–∞", "–∫–∞–Ω—Ü–µ–ª—è—Ä–∏—è", "–ø–µ—Ä–µ–µ–∑–¥"],
        "subcategories": {
            "access": {
                "name": "–ü—Ä–æ–ø—É—Å–∫–∞ –∏ –¥–æ—Å—Ç—É–ø",
                "keywords": ["–ø—Ä–æ–ø—É—Å–∫", "–∫–ª—é—á", "–∫–∞—Ä—Ç–∞", "–¥–≤–µ—Ä—å"],
                "articles": [
                    {
                        "question": "–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫?",
                        "answer": """–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞:

**–î–ª—è –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:**
1. HR –æ—Ñ–æ—Ä–º–ª—è–µ—Ç –∑–∞—è–≤–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. –ü—Ä–æ–ø—É—Å–∫ –≥–æ—Ç–æ–≤ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å
3. –ü–æ–ª—É—á–∏—Ç–µ –Ω–∞ —Ä–µ—Å–µ–ø—à–Ω —Å –ø–∞—Å–ø–æ—Ä—Ç–æ–º

**–ó–∞–º–µ–Ω–∞ –ø—Ä–æ–ø—É—Å–∫–∞:**
1. –ó–∞—è–≤–∫–∞ —á–µ—Ä–µ–∑ –ø–æ—Ä—Ç–∞–ª –ê–•–û
2. –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É (—É—Ç–µ—Ä—è/–ø–æ–ª–æ–º–∫–∞)
3. –°—Ä–æ–∫ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è: 1-2 –¥–Ω—è
4. –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–º–µ–Ω—ã: 5000 ‚Ç∏

**–í—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫:**
–í—ã–¥–∞—ë—Ç—Å—è –Ω–∞ —Ä–µ—Å–µ–ø—à–Ω –ø—Ä–∏ –ø—Ä–µ–¥—ä—è–≤–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞.""",
                        "can_auto_resolve": True,
                        "priority": "low",
                    },
                ],
            },
        },
    },
}

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI
SYSTEM_PROMPT = """–¢—ã - AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ–≥–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º —Ä–µ—à–∞—Ç—å –∏—Ö –ø—Ä–æ–±–ª–µ–º—ã.

–ü–†–ê–í–ò–õ–ê:
1. –û—Ç–≤–µ—á–∞–π –≤–µ–∂–ª–∏–≤–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ
2. –î–∞–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
3. –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π - –∏—Å–ø–æ–ª—å–∑—É–π –µ—ë
4. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ - —á–µ—Å—Ç–Ω–æ —Å–∫–∞–∂–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç
5. –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ (—Å–ø–∏—Å–∫–∏, –≤—ã–¥–µ–ª–µ–Ω–∏–µ)
6. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ç–æ–º —è–∑—ã–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–¥–∞–Ω –≤–æ–ø—Ä–æ—Å (—Ä—É—Å—Å–∫–∏–π –∏–ª–∏ –∫–∞–∑–∞—Ö—Å–∫–∏–π)
7. –ë—É–¥—å –∫—Ä–∞—Ç–∫–∏–º, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º

–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô:
{context}

–ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–µ–Ω –≤–æ–ø—Ä–æ—Å—É - –æ—Ç–≤–µ—á–∞–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π –æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–µ."""

SYSTEM_PROMPT_KZ = """–°–µ–Ω - –∫–æ–º–ø–∞–Ω–∏—è–Ω—ã“£ “õ–æ–ª–¥–∞—É “õ—ã–∑–º–µ—Ç—ñ–Ω—ñ“£ AI-–∫”©–º–µ–∫—à—ñ—Å—ñ—Å—ñ“£. –°–µ–Ω—ñ“£ –º—ñ–Ω–¥–µ—Ç—ñ“£ - “õ—ã–∑–º–µ—Ç–∫–µ—Ä–ª–µ—Ä–≥–µ –º”ô—Å–µ–ª–µ–ª–µ—Ä—ñ–Ω —à–µ—à—É–≥–µ –∫”©–º–µ–∫—Ç–µ—Å—É.

–ï–†–ï–ñ–ï–õ–ï–†:
1. –°—ã–ø–∞–π—ã –∂”ô–Ω–µ –∫”ô—Å—ñ–±–∏ –∂–∞—É–∞–ø –±–µ—Ä
2. –ù–∞“õ—Ç—ã –∂”ô–Ω–µ –ø–∞–π–¥–∞–ª—ã –∂–∞—É–∞–ø—Ç–∞—Ä –±–µ—Ä
3. –ë—ñ–ª—ñ–º –±–∞–∑–∞—Å—ã–Ω–∞–Ω —Å”ô–π–∫–µ—Å –∞“õ–ø–∞—Ä–∞—Ç –±–æ–ª—Å–∞ - –æ–Ω—ã –ø–∞–π–¥–∞–ª–∞–Ω
4. –ù–∞“õ—Ç—ã –∂–∞—É–∞–ø—Ç—ã –±—ñ–ª–º–µ—Å–µ“£ - —à—ã–Ω—ã–Ω –∞–π—Ç –∂”ô–Ω–µ —Ç–∏–∫–µ—Ç –∂–∞—Å–∞—É–¥—ã “±—Å—ã–Ω

–ë–Ü–õ–Ü–ú –ë–ê–ó–ê–°–´–ù–ê–ù –ö–û–ù–¢–ï–ö–°–¢:
{context}"""


class RAGService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–≥–æ RAG."""

    def __init__(self):
        self.api_key = getattr(settings, 'openai_api_key', None)
        self.model = getattr(settings, 'openai_model', 'gpt-4o-mini')
        self.use_openai = bool(self.api_key and self.api_key != "your-openai-api-key-here")
        self.knowledge_base = HIERARCHICAL_KNOWLEDGE_BASE

    def search_knowledge_base(
        self,
        query: str,
        top_k: int = 3,
    ) -> list[dict[str, Any]]:
        """
        –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.
        
        –£—Ä–æ–≤–µ–Ω—å 1: –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        –£—Ä–æ–≤–µ–Ω—å 2: –ü–æ–∏—Å–∫ –ø–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        –£—Ä–æ–≤–µ–Ω—å 3: –ü–æ–∏—Å–∫ –ø–æ —Å—Ç–∞—Ç—å—è–º
        """
        query_lower = query.lower()
        results = []
        
        # –£—Ä–æ–≤–µ–Ω—å 1: –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        for cat_key, category in self.knowledge_base.items():
            cat_score = 0
            for keyword in category.get("keywords", []):
                if keyword.lower() in query_lower:
                    cat_score += 2
            
            if cat_score > 0 or any(word in query_lower for word in category["name"].lower().split()):
                # –£—Ä–æ–≤–µ–Ω—å 2: –ü–æ–∏—Å–∫ –≤ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö
                for subcat_key, subcategory in category.get("subcategories", {}).items():
                    subcat_score = cat_score
                    for keyword in subcategory.get("keywords", []):
                        if keyword.lower() in query_lower:
                            subcat_score += 3
                    
                    # –£—Ä–æ–≤–µ–Ω—å 3: –ü–æ–∏—Å–∫ —Å—Ç–∞—Ç–µ–π
                    for article in subcategory.get("articles", []):
                        article_score = subcat_score
                        
                        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–ø—Ä–æ—Å–∞
                        question = article.get("question", "").lower()
                        for word in query_lower.split():
                            if len(word) > 3 and word in question:
                                article_score += 5
                        
                        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞
                        answer = article.get("answer", "").lower()
                        for word in query_lower.split():
                            if len(word) > 3 and word in answer:
                                article_score += 1
                        
                        if article_score > 0:
                            results.append({
                                "category": category["name"],
                                "subcategory": subcategory["name"],
                                "question": article["question"],
                                "answer": article["answer"],
                                "can_auto_resolve": article.get("can_auto_resolve", False),
                                "priority": article.get("priority", "medium"),
                                "score": article_score,
                            })
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø-K
        results.sort(key=lambda x: x["score"], reverse=True)
        return results[:top_k]

    def build_context(self, search_results: list[dict]) -> str:
        """–§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞."""
        if not search_results:
            return "–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π."
        
        context_parts = []
        for i, result in enumerate(search_results, 1):
            context_parts.append(f"""
--- –°—Ç–∞—Ç—å—è {i} ---
–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {result['category']} > {result['subcategory']}
–í–æ–ø—Ä–æ—Å: {result['question']}
–û—Ç–≤–µ—Ç: {result['answer']}
""")
        
        return "\n".join(context_parts)

    async def chat(
        self,
        message: str,
        conversation_history: list[dict[str, str]] | None = None,
        language: str = "ru",
    ) -> dict[str, Any]:
        """
        –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ —á–∞—Ç–∞ —Å RAG –∏ Function Calling.
        
        Returns:
            {
                "response": str,
                "sources": list,
                "can_auto_resolve": bool,
                "suggested_priority": str,
                "tool_call": dict | None,  # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏/—Ç–∏–∫–µ—Ç–µ
            }
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à Redis (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ–∑ –∏—Å—Ç–æ—Ä–∏–∏)
        from ...core.redis import redis_service
        
        use_cache = conversation_history is None or len(conversation_history) == 0
        
        if use_cache:
            cached = await redis_service.get_cached_rag_response(message, language)
            if cached:
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–±–µ–∑ tool_call –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
                return {
                    "response": cached.get("response", ""),
                    "sources": cached.get("sources", []),
                    "can_auto_resolve": cached.get("can_auto_resolve", False),
                    "suggested_priority": cached.get("suggested_priority", "medium"),
                    "tool_call": None,
                    "_cached": True,
                }
        
        # –®–∞–≥ 1: –ü–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
        search_results = self.search_knowledge_base(message)
        
        # –®–∞–≥ 2: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        context = self.build_context(search_results)
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –∞–≤—Ç–æ-—Ä–µ—à–∏—Ç—å
        can_auto_resolve = any(r.get("can_auto_resolve", False) for r in search_results)
        suggested_priority = search_results[0]["priority"] if search_results else "medium"
        
        # –®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π tools)
        tool_call_result = None
        
        if self.use_openai:
            ai_result = await self._generate_with_openai(
                message, context, conversation_history, language
            )
            response = ai_result["content"]
            tool_call_result = ai_result.get("tool_call")
            
            # –ï—Å–ª–∏ –±—ã–ª tool call, –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            if tool_call_result:
                can_auto_resolve = False  # –≠—Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–µ–π—Å—ã –Ω–µ –∞–≤—Ç–æ-—Ä–µ—à–∞—é—Ç—Å—è
                if tool_call_result.get("result", {}).get("priority"):
                    suggested_priority = tool_call_result["result"]["priority"]
        else:
            response = self._generate_fallback(message, search_results, language)
        
        result = {
            "response": response,
            "sources": [
                {
                    "category": r["category"],
                    "subcategory": r["subcategory"],
                    "question": r["question"],
                }
                for r in search_results
            ],
            "can_auto_resolve": can_auto_resolve,
            "suggested_priority": suggested_priority,
            "tool_call": tool_call_result,  # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —ç—Å–∫–∞–ª–∞—Ü–∏–∏/—Ç–∏–∫–µ—Ç–µ
        }
        
        # –ö–µ—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –µ—Å–ª–∏ –Ω–µ—Ç tool_call –∏ –µ—Å—Ç—å –∞–≤—Ç–æ-—Ä–µ—à–µ–Ω–∏–µ
        if use_cache and not tool_call_result and can_auto_resolve:
            await redis_service.cache_rag_response(message, result, language)
        
        return result

    async def _generate_with_openai(
        self,
        message: str,
        context: str,
        conversation_history: list[dict[str, str]] | None,
        language: str,
        use_tools: bool = True,
    ) -> dict[str, Any]:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ OpenAI —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Function Calling.
        
        Returns:
            {
                "content": str,           # –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
                "tool_call": dict | None, # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            }
        """
        
        system_prompt = SYSTEM_PROMPT_KZ if language == "kz" else SYSTEM_PROMPT
        system_prompt = system_prompt.format(context=context)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é tools
        system_prompt += """

–í–ê–ñ–ù–û: –£ —Ç–µ–±—è –µ—Å—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (tools) –¥–ª—è –ø–æ–º–æ—â–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:
1. escalate_to_operator - –ø–µ—Ä–µ–¥–∞—Ç—å —Å–ª–æ–∂–Ω—ã–π —Å–ª—É—á–∞–π –æ–ø–µ—Ä–∞—Ç–æ—Ä—É-—á–µ–ª–æ–≤–µ–∫—É
2. create_ticket - —Å–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ
3. check_ticket_status - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞
4. mark_resolved_by_ai - –æ—Ç–º–µ—Ç–∏—Ç—å —á—Ç–æ —Ç—ã —É—Å–ø–µ—à–Ω–æ —Ä–µ—à–∏–ª –ø—Ä–æ–±–ª–µ–º—É

–ò—Å–ø–æ–ª—å–∑—É–π escalate_to_operator –µ—Å–ª–∏:
- –¢—ã –Ω–µ –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å –∏–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å —á–µ–ª–æ–≤–µ–∫–æ–º
- –ü—Ä–æ–±–ª–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- –≠—Ç–æ —Å—Ä–æ—á–Ω–∞—è/–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

–ò—Å–ø–æ–ª—å–∑—É–π create_ticket –µ—Å–ª–∏:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
- –ü—Ä–æ–±–ª–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π mark_resolved_by_ai –µ—Å–ª–∏:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç —Ç–µ–±—è ("—Å–ø–∞—Å–∏–±–æ", "–±–ª–∞–≥–æ–¥–∞—Ä—é", "—Ä–∞—Ö–º–µ—Ç", "–∫—Ä—É—Ç–æ", "–æ—Ç–ª–∏—á–Ω–æ")
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞ ("—Ä–∞–±–æ—Ç–∞–µ—Ç", "–ø–æ–ª—É—á–∏–ª–æ—Å—å", "—Ä–∞–∑–æ–±—Ä–∞–ª—Å—è", "–ø–æ–Ω—è–ª")
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç —á—Ç–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –±–æ–ª—å—à–µ –Ω–µ—Ç
- –¢—ã –¥–∞–ª –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–≤–æ–ª–µ–Ω
–≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏!"""
        
        messages = [{"role": "system", "content": system_prompt}]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        if conversation_history:
            for msg in conversation_history[-10:]:
                role = "user" if msg.get("is_user") else "assistant"
                messages.append({"role": role, "content": msg["content"]})
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        messages.append({"role": "user", "content": message})
        
        request_body = {
            "model": self.model,
            "messages": messages,
            "temperature": 0.7,
            "max_tokens": 1000,
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º tools –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã
        if use_tools:
            request_body["tools"] = ESCALATION_TOOLS
            request_body["tool_choice"] = "auto"
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    "https://api.openai.com/v1/chat/completions",
                    headers={
                        "Authorization": f"Bearer {self.api_key}",
                        "Content-Type": "application/json",
                    },
                    json=request_body,
                    timeout=30.0,
                )
                response.raise_for_status()
                data = response.json()
                
                choice = data["choices"][0]
                message_data = choice["message"]
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –≤—ã–∑–≤–∞–Ω tool
                if message_data.get("tool_calls"):
                    tool_call = message_data["tool_calls"][0]
                    function_name = tool_call["function"]["name"]
                    function_args = json.loads(tool_call["function"]["arguments"])
                    
                    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º tool call
                    tool_result = await self._handle_tool_call(
                        function_name, function_args, language
                    )
                    
                    return {
                        "content": tool_result["message"],
                        "tool_call": {
                            "name": function_name,
                            "args": function_args,
                            "result": tool_result,
                        }
                    }
                
                # –û–±—ã—á–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ tool call
                return {
                    "content": message_data.get("content", ""),
                    "tool_call": None,
                }
                
        except Exception as e:
            print(f"OpenAI error: {e}")
            return {
                "content": self._generate_fallback(message, [], language),
                "tool_call": None,
            }

    async def _handle_tool_call(
        self,
        function_name: str,
        function_args: dict,
        language: str,
    ) -> dict[str, Any]:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–∑–æ–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞."""
        
        if function_name == "escalate_to_operator":
            return await self._escalate_to_operator(function_args, language)
        
        elif function_name == "create_ticket":
            return await self._create_ticket(function_args, language)
        
        elif function_name == "check_ticket_status":
            return await self._check_ticket_status(function_args, language)
        
        elif function_name == "mark_resolved_by_ai":
            return await self._mark_resolved_by_ai(function_args, language)
        
        return {
            "success": False,
            "message": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç",
        }

    async def _escalate_to_operator(
        self,
        args: dict,
        language: str,
    ) -> dict[str, Any]:
        """–≠—Å–∫–∞–ª–∞—Ü–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä—É."""
        
        department = args.get("department", "it_support")
        dept_info = DEPARTMENT_MAPPING.get(department, DEPARTMENT_MAPPING["it_support"])
        priority = args.get("priority", "medium")
        reason = args.get("reason", "")
        summary = args.get("summary", "")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä —ç—Å–∫–∞–ª–∞—Ü–∏–∏
        escalation_id = f"ESC-{datetime.now().strftime('%y%m%d')}-{uuid.uuid4().hex[:4].upper()}"
        
        if language == "kz":
            message = f"""üîÑ **–°—ñ–∑–¥—ñ“£ ”©—Ç—ñ–Ω—ñ—à—ñ“£—ñ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä“ì–∞ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ**

üìã **–≠—Å–∫–∞–ª–∞—Ü–∏—è –Ω”©–º—ñ—Ä—ñ:** {escalation_id}
üè¢ **–ë”©–ª—ñ–º:** {dept_info['name_kz']}
‚ö° **–ë–∞—Å—ã–º–¥—ã“õ:** {priority}

üìù **–ú”ô—Å–µ–ª–µ —Å–∏–ø–∞—Ç—Ç–∞–º–∞—Å—ã:**
{summary}

‚è±Ô∏è –û–ø–µ—Ä–∞—Ç–æ—Ä –∂–∞“õ—ã–Ω –∞—Ä–∞–¥–∞ —Å—ñ–∑–±–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å–∞–¥—ã.
–ö“Ø—Ç—É —É–∞“õ—ã—Ç—ã: —à–∞–º–∞–º–µ–Ω 15-30 –º–∏–Ω—É—Ç."""
        else:
            message = f"""üîÑ **–í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É**

üìã **–ù–æ–º–µ—Ä —ç—Å–∫–∞–ª–∞—Ü–∏–∏:** {escalation_id}
üè¢ **–û—Ç–¥–µ–ª:** {dept_info['name']}
‚ö° **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** {priority}

üìù **–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:**
{summary}

‚è±Ô∏è –û–ø–µ—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.
–û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: –æ–∫–æ–ª–æ 15-30 –º–∏–Ω—É—Ç."""
        
        return {
            "success": True,
            "action": "escalated",
            "escalation_id": escalation_id,
            "department": department,
            "department_name": dept_info["name"],
            "priority": priority,
            "reason": reason,
            "summary": summary,
            "message": message,
        }

    async def _create_ticket(
        self,
        args: dict,
        language: str,
    ) -> dict[str, Any]:
        """–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞."""
        
        subject = args.get("subject", "–ù–æ–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ")
        description = args.get("description", "")
        department = args.get("department", "it_support")
        priority = args.get("priority", "medium")
        
        dept_info = DEPARTMENT_MAPPING.get(department, DEPARTMENT_MAPPING["it_support"])
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä —Ç–∏–∫–µ—Ç–∞
        ticket_number = f"TKT-{datetime.now().strftime('%y%m%d')}-{uuid.uuid4().hex[:4].upper()}"
        
        if language == "kz":
            message = f"""‚úÖ **–¢–∏–∫–µ—Ç —Å”ô—Ç—Ç—ñ –∂–∞—Å–∞–ª–¥—ã!**

üé´ **–¢–∏–∫–µ—Ç –Ω”©–º—ñ—Ä—ñ:** {ticket_number}
üìã **–¢–∞“õ—ã—Ä—ã–ø:** {subject}
üè¢ **–ë”©–ª—ñ–º:** {dept_info['name_kz']}
‚ö° **–ë–∞—Å—ã–º–¥—ã“õ:** {priority}

–°—ñ–∑ –±“±–ª –Ω”©–º—ñ—Ä –±–æ–π—ã–Ω—à–∞ ”©—Ç—ñ–Ω—ñ—à—Ç—ñ“£ –∫“Ø–π—ñ–Ω —Ç–µ–∫—Å–µ—Ä–µ –∞–ª–∞—Å—ã–∑.
–ë—ñ–∑–¥—ñ“£ –º–∞–º–∞–Ω–¥–∞—Ä —Å—ñ–∑–≥–µ –∂–∞“õ—ã–Ω –∞—Ä–∞–¥–∞ –∂–∞—É–∞–ø –±–µ—Ä–µ–¥—ñ."""
        else:
            message = f"""‚úÖ **–¢–∏–∫–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!**

üé´ **–ù–æ–º–µ—Ä —Ç–∏–∫–µ—Ç–∞:** {ticket_number}
üìã **–¢–µ–º–∞:** {subject}
üè¢ **–û—Ç–¥–µ–ª:** {dept_info['name']}
‚ö° **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** {priority}

–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –ø–æ —ç—Ç–æ–º—É –Ω–æ–º–µ—Ä—É.
–ù–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã –æ—Ç–≤–µ—Ç—è—Ç –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."""
        
        return {
            "success": True,
            "action": "ticket_created",
            "ticket_number": ticket_number,
            "subject": subject,
            "department": department,
            "priority": priority,
            "message": message,
        }

    async def _check_ticket_status(
        self,
        args: dict,
        language: str,
    ) -> dict[str, Any]:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–∏–∫–µ—Ç–∞ (–∑–∞–≥–ª—É—à–∫–∞)."""
        
        ticket_number = args.get("ticket_number", "")
        
        # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ –ë–î
        # –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ–º–æ-–æ—Ç–≤–µ—Ç
        
        if language == "kz":
            message = f"""üîç **–¢–∏–∫–µ—Ç –∫“Ø–π—ñ: {ticket_number}**

üìä **–ö“Ø–π—ñ:** ”®“£–¥–µ–ª—É–¥–µ
üè¢ **–ë”©–ª—ñ–º:** IT “ö–æ–ª–¥–∞—É
üë§ **–ñ–∞—É–∞–ø—Ç—ã:** –¢–µ—Ö–Ω–∏–∫–∞–ª—ã“õ –º–∞–º–∞–Ω
‚è±Ô∏è **–ñ–∞—Å–∞–ª“ì–∞–Ω:** –ë“Ø–≥—ñ–Ω

üí¨ –°—ñ–∑–¥—ñ“£ ”©—Ç—ñ–Ω—ñ—à—ñ“£—ñ–∑ ”©“£–¥–µ–ª—É–¥–µ. –ñ–∞“£–∞—Ä—Ç—É–ª–∞—Ä –±–æ–ª“ì–∞–Ω –∫–µ–∑–¥–µ —Ö–∞–±–∞—Ä–ª–∞–π–º—ã–∑."""
        else:
            message = f"""üîç **–°—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞: {ticket_number}**

üìä **–°—Ç–∞—Ç—É—Å:** –í –æ–±—Ä–∞–±–æ—Ç–∫–µ
üè¢ **–û—Ç–¥–µ–ª:** IT –ü–æ–¥–¥–µ—Ä–∂–∫–∞
üë§ **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç
‚è±Ô∏è **–°–æ–∑–¥–∞–Ω:** –°–µ–≥–æ–¥–Ω—è

üí¨ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–±–æ—Ç–µ. –ú—ã —É–≤–µ–¥–æ–º–∏–º –≤–∞—Å –æ –ª—é–±—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö."""
        
        return {
            "success": True,
            "action": "status_checked",
            "ticket_number": ticket_number,
            "status": "processing",
            "message": message,
        }

    async def _mark_resolved_by_ai(
        self,
        args: dict,
        language: str,
    ) -> dict[str, Any]:
        """–û—Ç–º–µ—Ç–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫–∞–∫ —Ä–µ—à—ë–Ω–Ω–æ–µ AI."""
        
        resolution_summary = args.get("resolution_summary", "–í–æ–ø—Ä–æ—Å —Ä–µ—à—ë–Ω")
        user_satisfaction = args.get("user_satisfaction", "positive")
        resolution_type = args.get("resolution_type", "faq_answer")
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID —Ä–µ–∑–æ–ª—é—Ü–∏–∏
        resolution_id = f"RES-{datetime.now().strftime('%y%m%d')}-{uuid.uuid4().hex[:4].upper()}"
        
        resolution_type_labels = {
            "faq_answer": "–û—Ç–≤–µ—Ç –∏–∑ FAQ",
            "instruction_provided": "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", 
            "issue_clarified": "–í–æ–ø—Ä–æ—Å –ø—Ä–æ—è—Å–Ω—ë–Ω",
            "self_resolved": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–æ–±—Ä–∞–ª—Å—è —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ",
        }
        resolution_type_labels_kz = {
            "faq_answer": "FAQ-–¥–∞–Ω –∂–∞—É–∞–ø",
            "instruction_provided": "–ù“±—Å“õ–∞—É–ª—ã“õ –±–µ—Ä—ñ–ª–¥—ñ",
            "issue_clarified": "–°“±—Ä–∞“õ —Ç“Ø—Å—ñ–Ω–¥—ñ—Ä—ñ–ª–¥—ñ", 
            "self_resolved": "–ü–∞–π–¥–∞–ª–∞–Ω—É—à—ã ”©–∑—ñ —à–µ—à—Ç—ñ",
        }
        
        if language == "kz":
            message = f"""‚úÖ **”®—Ç—ñ–Ω—ñ—à —à–µ—à—ñ–ª–¥—ñ!**

ü§ñ **AI –∞—Ä“õ—ã–ª—ã —à–µ—à—ñ–ª–¥—ñ**
üìã **–®–µ—à—ñ–º:** {resolution_summary}
üìä **–®–µ—à—ñ–º —Ç“Ø—Ä—ñ:** {resolution_type_labels_kz.get(resolution_type, resolution_type)}

–ö”©–º–µ–≥—ñ–º “Ø—à—ñ–Ω —Ä–∞—Ö–º–µ—Ç! –ë–∞—Å“õ–∞ —Å“±—Ä–∞“õ—Ç–∞—Ä –±–æ–ª—Å–∞, “õ–∞–π—Ç–∞ —Ö–∞–±–∞—Ä–ª–∞—Å—ã“£—ã–∑. üòä"""
        else:
            message = f"""‚úÖ **–û–±—Ä–∞—â–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–æ!**

ü§ñ **–†–µ—à–µ–Ω–æ —Å –ø–æ–º–æ—â—å—é AI**
üìã **–†–µ—à–µ–Ω–∏–µ:** {resolution_summary}
üìä **–¢–∏–ø —Ä–µ—à–µ–Ω–∏—è:** {resolution_type_labels.get(resolution_type, resolution_type)}

–†–∞–¥ –±—ã–ª –ø–æ–º–æ—á—å! –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–Ω—É—Ç –¥—Ä—É–≥–∏–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å. üòä"""
        
        return {
            "success": True,
            "action": "resolved_by_ai",
            "resolution_id": resolution_id,
            "resolution_summary": resolution_summary,
            "user_satisfaction": user_satisfaction,
            "resolution_type": resolution_type,
            "message": message,
        }

    def _generate_fallback(
        self,
        message: str,
        search_results: list[dict],
        language: str,
    ) -> str:
        """Fallback –æ—Ç–≤–µ—Ç –±–µ–∑ OpenAI."""
        
        if search_results:
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ª—É—á—à–∏–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
            best = search_results[0]
            if language == "kz":
                return f"–ú–µ–Ω —Å—ñ–∑–¥—ñ“£ —Å“±—Ä–∞“ì—ã“£—ã–∑“ì–∞ –∂–∞—É–∞–ø —Ç–∞–ø—Ç—ã–º:\n\n{best['answer']}"
            return f"–ù–∞—à—ë–ª –æ—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å:\n\n{best['answer']}"
        
        if language == "kz":
            return "–ö–µ—à—ñ—Ä—ñ“£—ñ–∑, –º–µ–Ω –±“±–ª —Å“±—Ä–∞“õ“õ–∞ –Ω–∞“õ—Ç—ã –∂–∞—É–∞–ø —Ç–∞–±–∞ –∞–ª–º–∞–¥—ã–º. –¢–∏–∫–µ—Ç –∂–∞—Å–∞—É—ã“£—ã–∑–¥—ã “±—Å—ã–Ω–∞–º—ã–Ω, –±—ñ–∑–¥—ñ“£ –º–∞–º–∞–Ω–¥–∞—Ä —Å—ñ–∑–≥–µ –∫”©–º–µ–∫—Ç–µ—Å–µ–¥—ñ."
        
        return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –Ω–µ –Ω–∞—à—ë–ª —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å. –†–µ–∫–æ–º–µ–Ω–¥—É—é —Å–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç - –Ω–∞—à–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–º–æ–≥—É—Ç!"

    def add_to_knowledge_base(
        self,
        category_key: str,
        subcategory_key: str,
        article: dict,
    ) -> bool:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—å—é –≤ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.
        
        –ü–æ–∑–≤–æ–ª—è–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å RAG.
        """
        try:
            if category_key not in self.knowledge_base:
                return False
            
            category = self.knowledge_base[category_key]
            if subcategory_key not in category.get("subcategories", {}):
                return False
            
            category["subcategories"][subcategory_key]["articles"].append(article)
            return True
        except Exception:
            return False

    def get_categories(self) -> list[dict]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è UI."""
        result = []
        for key, cat in self.knowledge_base.items():
            subcats = []
            for subkey, subcat in cat.get("subcategories", {}).items():
                subcats.append({
                    "key": subkey,
                    "name": subcat["name"],
                    "article_count": len(subcat.get("articles", [])),
                })
            result.append({
                "key": key,
                "name": cat["name"],
                "name_kz": cat.get("name_kz"),
                "subcategories": subcats,
            })
        return result

    async def summarize(self, text: str, language: str = "ru") -> str:
        """
        –†–µ–∑—é–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é AI.
        """
        if not self.use_openai:
            # Fallback: –ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤
            return text[:200] + "..." if len(text) > 200 else text
        
        prompt = "–†–µ–∑—é–º–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É:" if language == "ru" else "–ú”ô—Ç—ñ–Ω–¥—ñ “õ—ã—Å“õ–∞—à–∞ —Ç“Ø–π—ñ–Ω–¥–µ“£—ñ–∑:"
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    "https://api.openai.com/v1/chat/completions",
                    headers={
                        "Authorization": f"Bearer {self.api_key}",
                        "Content-Type": "application/json",
                    },
                    json={
                        "model": self.model,
                        "messages": [
                            {"role": "system", "content": prompt},
                            {"role": "user", "content": text},
                        ],
                        "temperature": 0.3,
                        "max_tokens": 300,
                    },
                    timeout=30.0,
                )
                response.raise_for_status()
                data = response.json()
                return data["choices"][0]["message"]["content"]
        except Exception as e:
            print(f"Summarize error: {e}")
            return text[:200] + "..." if len(text) > 200 else text

    async def translate(self, text: str, target_language: str) -> str:
        """
        –ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É —Ä—É—Å—Å–∫–∏–º –∏ –∫–∞–∑–∞—Ö—Å–∫–∏–º.
        """
        if not self.use_openai:
            return f"[–ü–µ—Ä–µ–≤–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω] {text}"
        
        if target_language == "kz":
            prompt = "–ü–µ—Ä–µ–≤–µ–¥–∏ —Å–ª–µ–¥—É—é—â–∏–π —Ç–µ–∫—Å—Ç –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–∏–π —è–∑—ã–∫. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–≤–æ–¥–æ–º:"
        else:
            prompt = "–ö–µ–ª–µ—Å—ñ –º”ô—Ç—ñ–Ω–¥—ñ –æ—Ä—ã—Å —Ç—ñ–ª—ñ–Ω–µ –∞—É–¥–∞—Ä—ã“£—ã–∑. –¢–µ–∫ –∞—É–¥–∞—Ä–º–∞–Ω—ã –∂–∞–∑—ã“£—ã–∑:"
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    "https://api.openai.com/v1/chat/completions",
                    headers={
                        "Authorization": f"Bearer {self.api_key}",
                        "Content-Type": "application/json",
                    },
                    json={
                        "model": self.model,
                        "messages": [
                            {"role": "system", "content": prompt},
                            {"role": "user", "content": text},
                        ],
                        "temperature": 0.3,
                        "max_tokens": 1000,
                    },
                    timeout=30.0,
                )
                response.raise_for_status()
                data = response.json()
                return data["choices"][0]["message"]["content"]
        except Exception as e:
            print(f"Translate error: {e}")
            return f"[–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞] {text}"

    async def generate_response_suggestion(
        self,
        client_message: str,
        context: str | None = None,
        language: str = "ru",
    ) -> str:
        """
        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.
        """
        # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
        search_results = self.search_knowledge_base(client_message)
        kb_context = self.build_context(search_results)
        
        if not self.use_openai:
            # Fallback: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª—É—á—à–∏–π –æ—Ç–≤–µ—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
            if search_results:
                return search_results[0]["answer"]
            return "–†–µ–∫–æ–º–µ–Ω–¥—É—é —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —É –∫–ª–∏–µ–Ω—Ç–∞."
        
        system_prompt = f"""–¢—ã - –ø–æ–º–æ—â–Ω–∏–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏. 
–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –≤–µ–∂–ª–∏–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞.

–ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:
{kb_context}

{f"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: {context}" if context else ""}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ {'—Ä—É—Å—Å–∫–æ–º' if language == 'ru' else '–∫–∞–∑–∞—Ö—Å–∫–æ–º'} —è–∑—ã–∫–µ
- –í–µ–∂–ª–∏–≤—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏ —Ä–µ—à–µ–Ω–∏—è –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–º–æ—â–∏ –≤ –∫–æ–Ω—Ü–µ"""
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    "https://api.openai.com/v1/chat/completions",
                    headers={
                        "Authorization": f"Bearer {self.api_key}",
                        "Content-Type": "application/json",
                    },
                    json={
                        "model": self.model,
                        "messages": [
                            {"role": "system", "content": system_prompt},
                            {"role": "user", "content": f"–°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞: {client_message}"},
                        ],
                        "temperature": 0.7,
                        "max_tokens": 500,
                    },
                    timeout=30.0,
                )
                response.raise_for_status()
                data = response.json()
                return data["choices"][0]["message"]["content"]
        except Exception as e:
            print(f"Suggestion error: {e}")
            if search_results:
                return search_results[0]["answer"]
            return "–†–µ–∫–æ–º–µ–Ω–¥—É—é —É—Ç–æ—á–Ω–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —É –∫–ª–∏–µ–Ω—Ç–∞."

    async def analyze_conversation_for_kb(
        self,
        conversation: str,
        summary: str = "",
        language: str = "ru",
    ) -> dict[str, Any]:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–∫—É –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É, —Ä–µ—à–µ–Ω–∏–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.
        """
        if not self.use_openai:
            return {
                "problem": summary or "–ü—Ä–æ–±–ª–µ–º–∞ –∫–ª–∏–µ–Ω—Ç–∞",
                "solution": "–†–µ—à–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º",
                "suggested_question": summary or "–í–æ–ø—Ä–æ—Å –¥–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π",
                "suggested_answer": "–û—Ç–≤–µ—Ç —Ç—Ä–µ–±—É–µ—Ç —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º",
                "suggested_category": "it_support",
                "suggested_subcategory": "software",
                "can_auto_resolve": False,
            }
        
        system_prompt = """–¢—ã - –∞–Ω–∞–ª–∏—Ç–∏–∫ —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–µ—Ä–µ–ø–∏—Å–∫—É –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º.

–ò–∑–≤–ª–µ–∫–∏:
1. –ü–†–û–ë–õ–ï–ú–£ –∫–ª–∏–µ–Ω—Ç–∞ (–∫—Ä–∞—Ç–∫–æ, 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
2. –†–ï–®–ï–ù–ò–ï, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –æ–ø–µ—Ä–∞—Ç–æ—Ä (–ø–æ–¥—Ä–æ–±–Ω–æ, –ø–æ—à–∞–≥–æ–≤–æ –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
3. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –í–û–ü–†–û–° –¥–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (–∫–∞–∫ –±—ã –∫–ª–∏–µ–Ω—Ç –º–æ–≥ —Å–ø—Ä–æ—Å–∏—Ç—å)
4. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –û–¢–í–ï–¢ –¥–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (–ø–æ–ª–Ω—ã–π, –ø–æ–Ω—è—Ç–Ω—ã–π, —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π)
5. –ü—Ä–µ–¥–ª–æ–∂–∏ –ö–ê–¢–ï–ì–û–†–ò–Æ (it_support, hr, finance, facilities)
6. –ü—Ä–µ–¥–ª–æ–∂–∏ –ü–û–î–ö–ê–¢–ï–ì–û–†–ò–Æ:
   - it_support: passwords, vpn, hardware, software
   - hr: vacation, documents, benefits
   - finance: salary, expenses, invoices
   - facilities: office, supplies, parking
7. –û–ø—Ä–µ–¥–µ–ª–∏, –º–æ–∂–Ω–æ –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–µ—à–∞—Ç—å —Ç–∞–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã (true/false)

–û—Ç–≤–µ—Ç –°–¢–†–û–ì–û –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{
    "problem": "...",
    "solution": "...",
    "suggested_question": "...",
    "suggested_answer": "...",
    "suggested_category": "...",
    "suggested_subcategory": "...",
    "can_auto_resolve": true/false
}"""
        
        try:
            async with httpx.AsyncClient() as client:
                response = await client.post(
                    "https://api.openai.com/v1/chat/completions",
                    headers={
                        "Authorization": f"Bearer {self.api_key}",
                        "Content-Type": "application/json",
                    },
                    json={
                        "model": self.model,
                        "messages": [
                            {"role": "system", "content": system_prompt},
                            {"role": "user", "content": f"–ü–µ—Ä–µ–ø–∏—Å–∫–∞:\n\n{conversation}\n\n–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è: {summary}"},
                        ],
                        "temperature": 0.3,
                        "max_tokens": 1000,
                        "response_format": {"type": "json_object"},
                    },
                    timeout=60.0,
                )
                response.raise_for_status()
                data = response.json()
                content = data["choices"][0]["message"]["content"]
                
                import json
                result = json.loads(content)
                return result
        except Exception as e:
            print(f"Analyze conversation error: {e}")
            return {
                "problem": summary or "–ü—Ä–æ–±–ª–µ–º–∞ –∫–ª–∏–µ–Ω—Ç–∞",
                "solution": "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ä–µ—à–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏",
                "suggested_question": summary or "–í–æ–ø—Ä–æ—Å –¥–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π",
                "suggested_answer": "–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞",
                "suggested_category": "it_support",
                "suggested_subcategory": "software",
                "can_auto_resolve": False,
                "error": str(e),
            }


# Singleton instance
rag_service = RAGService()

